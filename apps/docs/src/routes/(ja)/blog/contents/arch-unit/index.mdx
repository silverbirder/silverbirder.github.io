---
title: TypescriptでArchUnitしてみた
published: true
date: 2020-11-28
description: ArchUnitをというものを最近知りました。依存関係のテストができるそうです。さっそく試してみたいと思いますので、その備忘録として残しておきます。
tags: ["Typescript", "Unit Test", "Arch Unit", "Testing"]
cover_image: https://res.cloudinary.com/silverbirder/image/upload/v1693376915/silver-birder.github.io/blog/CleanArchitecture.jpg
socialMediaImage: https://res.cloudinary.com/silverbirder/image/upload/v1693376915/silver-birder.github.io/blog/CleanArchitecture.jpg
---

import { Image } from "~/components/image/image";

ArchUnit をというものを最近知りました。依存関係のテストができるそうです。さっそく試してみたいと思いますので、その備忘録として残しておきます。

# ArchUnit

https://www.archunit.org/

> ArchUnit is a free, simple and extensible library for checking the architecture of your Java code using any plain Java unit test framework. That is, ArchUnit can check dependencies between packages and classes, layers and slices, check for cyclic dependencies and more. It does so by analyzing given Java bytecode, importing all classes into a Java code structure.

Java のアーキテクチャをテストできるライブラリで、パッケージやクラス、レイヤー、スライス（？）の依存関係をテストできるそうです。
そこで、親の顔よりも見たこの図をテストしたいと思います。

<Image
  src="https://res.cloudinary.com/silverbirder/image/upload/v1693376915/silver-birder.github.io/blog/CleanArchitecture.jpg"
  width={772}
  height={567}
  layout="constrained"
  alt="Clean Coder Blog > The Clean Architecture"
  href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html"
/>

# Typescript でも ArchUnit したい

ArchUnit は Java 製です。私は Typescript の ArchUnit がしたいです。
そこで、良さげなライブラリを発見しました。

https://github.com/MaibornWolff/ts-arch

特に拘りなく、アーキテクチャのテストができれば何でも良いかなと思います。
極端な話、ソースコードを AST パースし、依存関係を抽出できれば自作できるんじゃないかと思います。

# 試してみた

試したソースコードは、下記に置いています。ご参考下さい。

https://github.com/silverbirder/try-archunit

全体のソースコードツリーは次の構成です。

```
src
└ 1_enterprise_business_rules
  └ entities
    └ Entity.ts
└ 2_application_business_rules
  └ use_cases
    └ UseCase.ts
└ 3_interface_adapters
  └ controllers
    └ Controller.ts
  └ gateways
    └ Gateway.ts
  └ presenters
    └ Presenter.ts
└ 4_frameworks_and_drivers
  └ web
    └ Web.ts
└ clean_architecture.puml
└ clean_architecture.test.ts
```

各プロダクトコードは、下の階層のファイルを import しているだけとします。

```typescript
// src/4_frameworks_and_drivers/web/Web.ts
import "../../3_interface_adapters/gateways/Gateway";
import "../../3_interface_adapters/controllers/Controller";
import "../../3_interface_adapters/presenters/Presenter";
```

```typescript
// src/3_interface_adapters/controllers/Controller.ts
import "../../2_application_business_rules/use_cases/UseCase";
```

```typescript
// src/2_application_business_rules/use_cases/UseCase.ts
import "../../1_enterprise_business_rules/entities/Entity";
```

```typescript
// src/1_enterprise_business_rules/entities/Entity.ts
```

下記ファイルにある UML のコンポーネント図で依存関係を表します。

```
# clean_architecture.puml
@startuml
  component [4_frameworks_and_drivers] #Blue
  component [3_interface_adapters] #Green
  component [2_application_business_rules] #Red
  component [1_enterprise_business_rules] #Yellow

  4_frameworks_and_drivers --> 3_interface_adapters
  3_interface_adapters --> 2_application_business_rules
  2_application_business_rules --> 1_enterprise_business_rules
@enduml
```

UML を可視化すると、下記の図のとおりです。

<Image
  src="https://res.cloudinary.com/silverbirder/image/upload/v1614430164/silver-birder.github.io/blog/clean_architecture.puml.png"
  width={470}
  height={684}
  layout="constrained"
  alt="clean_architecture.puml"
/>

テストコードは、下記のとおりです。

```typescript
// clean_architecture.test.ts
describe("architecture", () => {
  it("Check dependency", async () => {
    const architectureUml = path.resolve(__dirname, "clean_architecture.puml");
    const violations = await slicesOfProject()
      .definedBy("src/(**)/")
      .should()
      .adhereToDiagramInFile(architectureUml)
      .check();
    await expect(violations).toEqual([]);
  });
});
```

このテストケースは PASS します。

<Image
  src="https://res.cloudinary.com/silverbirder/image/upload/v1614430233/silver-birder.github.io/blog/src_clean_architecture_test_ts_architecture_check_dependency_succeed.png"
  width={962}
  height={422}
  layout="constrained"
  alt="src/clean_architecture.test.ts > architecture > Check dependency #Succeed"
/>

では、違反コードを書いてみます。

```typescript
// src/3_interface_adapters/controllers/Controller.ts
import "../../2_application_business_rules/use_cases/UseCase";
import "../../4_frameworks_and_drivers/web/Web";
```

3 レイヤーが上位の 4 レイヤーを使用しています。この状態でテストを実行すると、

<Image
  src="https://res.cloudinary.com/silverbirder/image/upload/v1614430292/silver-birder.github.io/blog/src_clean_architecture_test_ts_architecture_check_dependency_failed.png"
  width={1200}
  height={564}
  layout="constrained"
  alt="src/clean_architecture.test.ts > architecture > Check dependency #Failed"
/>

見事 Failed となりました。つまり、依存関係の誤りを自動的に検出することができます。

# 最後に

規模が大きなプロジェクトほど、依存関係が複雑になりがちです。(Java でいう) パッケージやクラスの依存関係を適切に設計できていたとしても、誰かが壊しかねません。せっかく設計したのに壊されるのは、とても残念なので、テストコードで守ってあげましょう！
