---
title: 'Storybook ã® Story ã‚’ Vitest Browser Mode with Playwright ã§ VRT'
publishedAt: '2025-12-03'
summary: ''
tags: []
---

Storybook ã® Story ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ Vitest ã® Browser Mode ã ã‘ã§ã€Visual Regression Testï¼ˆVRTï¼‰ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ãã®å°å…¥æ‰‹é †ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ç´¹ä»‹ã—ã¾ã™ã€‚

## å‰æ

ä»¥ä¸‹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã«é€²ã‚ã¾ã™ã€‚

- Storybook ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  - ğŸ‘‰ https://storybook.js.org/docs/get-started/setup
- Vitest Browser Mode ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  - ğŸ‘‰ https://vitest.dev/guide/browser

ã¾ãŸã€ä»¥ä¸‹ 2 ã¤ã® Storybook ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å‹•ä½œç¢ºèªæ¸ˆã¿ã§ã™ã€‚

- https://www.npmjs.com/package/@storybook/nextjs-vite
  - â€»ä½µã›ã¦ä»¥ä¸‹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦
     - https://www.npmjs.com/package/vite-plugin-storybook-nextjs 
- https://www.npmjs.com/package/@storybook/react-vite

åŠ ãˆã¦ã€ã“ã®è¨˜äº‹ã‚‚å‚è€ƒã«ãªã‚Šã¾ã™ã€‚

https://storybook.js.org/docs/api/portable-stories/portable-stories-vitest

## Vitestã®è¨­å®š

ã¾ãšã€Vitest ã§ Browser Mode ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

```js
// vitest.config.js
import react from "@vitejs/plugin-react";
// import nextjs from "vite-plugin-storybook-nextjs"; // nextjs-vite ã‚’ä½¿ã†å ´åˆ
import { playwright } from "@vitest/browser-playwright";
import { defineConfig } from "vitest/config";

/*
 * @type {import("vitest/config").ViteUserConfigExport}
 */
const baseConfig = {
  plugins: [
    react(), 
    // nextjs(),
  ],
  test: {
    include: ["src/**/*.test.{ts,tsx}", "src/**/*.spec.{ts,tsx}"],
    setupFiles: ["./vitest.setup.js"],
    browser: {  // ğŸ‘ˆ Browser Mode ã®è¨­å®š
      enabled: true,
      provider: playwright(),
      headless: true,
      instances: [{ browser: "chromium" }],
    },
  },
};

export default defineConfig(baseConfig);
```

Vitest Browser Mode å‘ã‘ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚‚è¿½åŠ ã—ã¾ã™ã€‚

```js
// vitest.setup.js
import "vitest-browser-react";
```

## Story ã‚’ VRT ã™ã‚‹

ã§ã¯ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ Storyã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```ts
// ./bubble-text.tsx
type Props = {
  text: string;
};

export const BubbleText = ({ text }: Props) => {
  return (
    <div>{text}</div>
  );
};
```

### Storyãƒ•ã‚¡ã‚¤ãƒ«

```ts
// ./bubble-text.stories.tsx
import type { Meta, StoryObj } from "@storybook/react-vite";
// or
// import type { Meta, StoryObj } from "@storybook/nextjs-vite";

import { BubbleText } from "./bubble-text";

const meta = {
  args: {
    text: "Hello, World",
  },
  component: BubbleText,
} satisfies Meta<typeof BubbleText>;

export default meta;
type Story = StoryObj<typeof meta>;

export const Default: Story = {};
```

### VRT ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
#### 1. `@storybook/nextjs-vite` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

`composeStories` ã§ Story ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã¾ã¨ã‚ã¦å–å¾—ã—ã€
`Story.run()` â†’ `toMatchScreenshot()` ã®æµã‚Œã§ VRT ã§ãã¾ã™ã€‚

```ts
// ./bubble-text.spec.tsx
import { composeStories } from "@storybook/nextjs-vite";
import { describe, expect, it } from "vitest";
import * as stories from "./bubble-text.stories";

const Stories = composeStories(stories);

describe("BubbleText", () => {
  it.each(Object.entries(Stories))("should %s snapshot", async (_, Story) => {
    // Act
    await Story.run();

    // Assert
    await expect(document.body).toMatchScreenshot();
  });
});
```

#### 2. `@storybook/react-vite` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

`@storybook/nextjs-vite` ã¨åŒæ§˜ã«ã€`composeStories` ã§ Story ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã¾ã¨ã‚ã¦å–å¾—ã—ã€ `render` â†’ `toMatchScreenshot()` ã®æµã‚Œã§ VRT ã§ãã¾ã™ã€‚

```ts
import { composeStories } from "@storybook/react-vite";
import { describe, expect, it } from "vitest";
import { render } from "vitest-browser-react";
import * as stories from "./bubble-text.stories";

const Stories = composeStories(stories);

describe("BubbleText", () => {
  it.each(Object.entries(Stories))("should %s snapshot", async (_, Story) => {
    // Act
    const { getByTestId } = await render(
      <div data-testid="test">
        <Story />
      </div>,
    );

    await expect(getByTestId("test")).toMatchScreenshot();
  });
});
```

ã“ã‚Œã«ã‚ˆã‚Šã€Storybook ã¨ Vitest ã ã‘ã§å®Œçµã™ã‚‹ VRT ç’°å¢ƒãŒæ§‹ç¯‰ã§ãã¾ã—ãŸï¼ğŸ‰

## å‚™è€ƒ

https://zenn.dev/silverbirder/articles/7b2795f6b26f98
