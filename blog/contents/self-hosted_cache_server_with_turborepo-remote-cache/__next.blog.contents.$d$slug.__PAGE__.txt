1:"$Sreact.fragment"
2:I[36926,["/_next/static/chunks/5af7d63d3817c0ad.js","/_next/static/chunks/2135796b958376e0.js","/_next/static/chunks/f06f97cc5d67ef22.js"],"PostArticle"]
6:I[85089,["/_next/static/chunks/ac58007543a7ba41.js","/_next/static/chunks/10f1e981bebff83b.js"],"OutletBoundary"]
7:"$Sreact.suspense"
3:Tc41a,"use strict";
const {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];
const {useMDXComponents: _provideComponents} = arguments[0];
function _createMdxContent(props) {
  const _components = {
    a: "a",
    code: "code",
    figure: "figure",
    h2: "h2",
    h3: "h3",
    li: "li",
    ol: "ol",
    p: "p",
    pre: "pre",
    span: "span",
    ul: "ul",
    ..._provideComponents(),
    ...props.components
  };
  return _jsxs(_Fragment, {
    children: [_jsx(_components.p, {
      children: "vercel 製の turborepo という ビルドシステムが爆速なモノレポツールがあります。\n爆速にする機能の 1 つに、リモートキャッシュというものがあります。\nこの機能は vercel のキャッシュサーバを使うのですが、キャッシュサーバをセルフホストする方法もあります。\n今回は、それを紹介します。"
    }), "\n", _jsx(_components.h2, {
      id: "なぜセルフホストしたいのか",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#なぜセルフホストしたいのか",
        children: "なぜ、セルフホストしたいのか"
      })
    }), "\n", _jsxs(_components.p, {
      children: ["vercel のキャッシュサーバを使う場合、vercel のアカウントが必要です。\n", _jsx(_components.a, {
        href: "https://vercel.com/pricing",
        children: "vercel の pricing"
      }), "を見ると、個人利用(Hobby)では無料ですが、会社(Pro)で使うとすると、", _jsx(_components.code, {
        children: "$20 per user / month"
      }), " という価格になります。費用対効果に見合うならそれで良いかもしれませんが、まだそれがわからない段階でコストをかけられない場面もあると思います。そこで、", _jsx(_components.a, {
        href: "https://turborepo.org/docs/core-concepts/remote-caching#custom-remote-caches",
        children: "公式にも書いてある"
      }), "とおり、キャッシュサーバをセルフホストする方法があります。"]
    }), "\n", _jsx(_components.h2, {
      id: "ローカルでやってみた",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#ローカルでやってみた",
        children: "ローカルで、やってみた"
      })
    }), "\n", _jsx(_components.p, {
      children: "実際に試してみました。ソースコードは、次のリンクにあります。"
    }), "\n", _jsxs(_components.ul, {
      children: ["\n", _jsx(_components.li, {
        children: _jsx(_components.a, {
          href: "https://github.com/silverbirder/turborepo-with-selfhost-remote-cache",
          children: "https://github.com/silverbirder/turborepo-with-selfhost-remote-cache"
        })
      }), "\n"]
    }), "\n", _jsx(_components.p, {
      children: "手元に Git clone して、README に従って動作確認できると思います。必要なソフトウェアは、Docker と Yarn です。"
    }), "\n", _jsx(_components.h3, {
      id: "キャッシュサーバの準備",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#キャッシュサーバの準備",
        children: "キャッシュサーバの準備"
      })
    }), "\n", _jsxs(_components.p, {
      children: ["セルフホストする場合、キャッシュサーバを建てる必要があります。\nキャッシュサーバは、", _jsx(_components.a, {
        href: "https://github.com/fox1t/turborepo-remote-cache",
        children: "https://github.com/fox1t/turborepo-remote-cache"
      }), " を使うと良いです。\nDocker イメージが公開されているので、それを使っても良いですし、自前で ", _jsx(_components.code, {
        children: "docker build"
      }), " しても良いです。"]
    }), "\n", _jsxs(_components.ul, {
      children: ["\n", _jsxs(_components.li, {
        children: ["Docker イメージ\n", _jsxs(_components.ul, {
          children: ["\n", _jsx(_components.li, {
            children: _jsx(_components.a, {
              href: "https://hub.docker.com/r/fox1t/turborepo-remote-cache",
              children: "https://hub.docker.com/r/fox1t/turborepo-remote-cache"
            })
          }), "\n"]
        }), "\n"]
      }), "\n"]
    }), "\n", _jsx(_components.p, {
      children: "キャッシュサーバには、最低でも次の 2 つを環境変数を設定する必要があります。"
    }), "\n", _jsxs(_components.ul, {
      children: ["\n", _jsxs(_components.li, {
        children: ["TURBO_TOKEN\n", _jsxs(_components.ul, {
          children: ["\n", _jsx(_components.li, {
            children: "turborepo と api を繋げるための TOKEN"
          }), "\n"]
        }), "\n"]
      }), "\n", _jsxs(_components.li, {
        children: ["STORAGE_PATH\n", _jsxs(_components.ul, {
          children: ["\n", _jsx(_components.li, {
            children: "キャッシュオブジェクトを保存するパス"
          }), "\n", _jsxs(_components.li, {
            children: ["STORAGE_PROVIDER が ", _jsx(_components.code, {
              children: "s3"
            }), " を指定する場合は、バケット名"]
          }), "\n"]
        }), "\n"]
      }), "\n"]
    }), "\n", _jsx(_components.p, {
      children: "簡単にするため、次の.env ファイルを用意しました。"
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "text",
        "data-theme": "github-dark github-light",
        children: _jsxs(_components.code, {
          "data-language": "text",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: [_jsx(_components.span, {
            "data-line": "",
            children: _jsx(_components.span, {
              children: "## .env"
            })
          }), "\n", _jsx(_components.span, {
            "data-line": "",
            children: _jsx(_components.span, {
              children: "TURBO_TOKEN=mytoken"
            })
          }), "\n", _jsx(_components.span, {
            "data-line": "",
            children: _jsx(_components.span, {
              children: "STORAGE_PATH=/storage/"
            })
          })]
        })
      })
    }), "\n", _jsx(_components.p, {
      children: "あとは、キャッシュサーバを起動するために、docker-compose を書きます。"
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "yml",
        "data-theme": "github-dark github-light",
        children: _jsxs(_components.code, {
          "data-language": "yml",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: [_jsx(_components.span, {
            "data-line": "",
            children: _jsx(_components.span, {
              style: {
                "--shiki-dark": "#6A737D",
                "--shiki-light": "#6A737D"
              },
              children: "## docker-compose.yml"
            })
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#85E89D",
                "--shiki-light": "#22863A"
              },
              children: "services"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: ":"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#85E89D",
                "--shiki-light": "#22863A"
              },
              children: "  remote-cache"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: ":"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#85E89D",
                "--shiki-light": "#22863A"
              },
              children: "    image"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: ": "
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "fox1t/turborepo-remote-cache:latest"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#85E89D",
                "--shiki-light": "#22863A"
              },
              children: "    env_file"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: ":"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: "      - "
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: ".env"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#85E89D",
                "--shiki-light": "#22863A"
              },
              children: "    ports"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: ":"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#E1E4E8",
                "--shiki-light": "#24292E"
              },
              children: "      - "
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"3000:3000\""
            })]
          })]
        })
      })
    }), "\n", _jsx(_components.p, {
      children: "次のコマンドで、キャッシュサーバを起動しましょう。"
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "bash",
        "data-theme": "github-dark github-light",
        children: _jsx(_components.code, {
          "data-language": "bash",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "docker-compose"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " up"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " -d"
            })]
          })
        })
      })
    }), "\n", _jsx(_components.p, {
      children: "これで、キャッシュサーバは PORT:3000 番 で起動します。"
    }), "\n", _jsx(_components.h3, {
      id: "turbo-build",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#turbo-build",
        children: "turbo build"
      })
    }), "\n", _jsx(_components.p, {
      children: "では、実際に turborepo からつながるか、試してみます。"
    }), "\n", _jsxs(_components.p, {
      children: ["turborepo は、", _jsx(_components.code, {
        children: "npx create-turbo@latest"
      }), " で作成できます。\n作成後、作成したフォルダで次のコマンドを実行します。"]
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "bash",
        "data-theme": "github-dark github-light",
        children: _jsxs(_components.code, {
          "data-language": "bash",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: [_jsx(_components.span, {
            "data-line": "",
            children: _jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "yarn"
            })
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "yarn"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " turbo"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " run"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " build"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --team="
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"team_myteam\""
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --token="
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"mytoken\""
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --api="
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"http://localhost:3000\""
            })]
          })]
        })
      })
    }), "\n", _jsx(_components.p, {
      children: "turbo コマンドのオプションで、3 つ指定します。"
    }), "\n", _jsxs(_components.ul, {
      children: ["\n", _jsxs(_components.li, {
        children: ["team\n", _jsxs(_components.ul, {
          children: ["\n", _jsx(_components.li, {
            children: "キャッシュを保存するときの名前空間の役割"
          }), "\n"]
        }), "\n"]
      }), "\n", _jsxs(_components.li, {
        children: ["token\n", _jsxs(_components.ul, {
          children: ["\n", _jsx(_components.li, {
            children: "先程定義した環境変数"
          }), "\n"]
        }), "\n"]
      }), "\n", _jsxs(_components.li, {
        children: ["api\n", _jsxs(_components.ul, {
          children: ["\n", _jsx(_components.li, {
            children: "キャッシュサーバの URL"
          }), "\n"]
        }), "\n"]
      }), "\n"]
    }), "\n", _jsx(_components.p, {
      children: "実行すると次のログが表示されるはずです。"
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "bash",
        "data-theme": "github-dark github-light",
        children: _jsxs(_components.code, {
          "data-language": "bash",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: [_jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "yarn"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " run"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " v1.22.19"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "turbo"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " run"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " build"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --team=team_myteam"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --token=mytoken"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --api=http://localhost:3000"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "•"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Packages"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " in"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " scope:"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " docs,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " eslint-config-custom,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " tsconfig,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " ui,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " web"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "•"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Running"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " build"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " in"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " 5"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " packages"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "•"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Remote"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " computation"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " caching"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " enabled"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "web:build:"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " cache"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " miss,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " executing"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 082bae5de9b1745f"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "docs:build:"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " cache"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " miss,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " executing"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 5a55c6367c8caf01"
            })]
          }), "\n", _jsx(_components.span, {
            "data-line": "",
            children: _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: "..."
            })
          })]
        })
      })
    }), "\n", _jsxs(_components.p, {
      children: [_jsx(_components.code, {
        children: "Remote computation caching enabled"
      }), " で、リモートキャッシュが有効となりました。\n初回の場合、cache miss となります。ハッシュ値は、", _jsx(_components.code, {
        children: "web: 082bae5de9b1745f"
      }), " と ", _jsx(_components.code, {
        children: "docs:5a55c6367c8caf01"
      }), " になります。\nキャッシュがローカルに保存されるため、削除します。"]
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "bash",
        "data-theme": "github-dark github-light",
        children: _jsx(_components.code, {
          "data-language": "bash",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "rm"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " -rf"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " node_modules/.cache/turbo"
            })]
          })
        })
      })
    }), "\n", _jsx(_components.p, {
      children: "ではもう一度、turbo build してみましょう。"
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "bash",
        "data-theme": "github-dark github-light",
        children: _jsxs(_components.code, {
          "data-language": "bash",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: [_jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "yarn"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " turbo"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " run"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " build"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --team="
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"team_myteam\""
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --token="
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"mytoken\""
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --api="
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "\"http://localhost:3000\""
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "yarn"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " run"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " v1.22.19"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "/Users/silverbirder/docker/node/turborepo-with-selfhost-remote-cache/node_modules/.bin/turbo"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " run"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " build"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --team=team_myteam"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --token=mytoken"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " --api=http://localhost:3000"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "•"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Packages"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " in"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " scope:"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " docs,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " eslint-config-custom,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " tsconfig,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " ui,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " web"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "•"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Running"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " build"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " in"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " 5"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " packages"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "•"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Remote"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " computation"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " caching"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " enabled"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "docs:build:"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " cache"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " hit,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " replaying"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " output"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 5a55c6367c8caf01"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "web:build:"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " cache"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " hit,"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " replaying"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " output"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 082bae5de9b1745f"
            })]
          })]
        })
      })
    }), "\n", _jsxs(_components.p, {
      children: ["どうでしょうか、", _jsx(_components.code, {
        children: "cache hit"
      }), " と表示されています。手元にキャッシュがないのにも関わらず、リモートのキャッシュサーバにキャッシュがあるため、", _jsx(_components.code, {
        children: "cache hit"
      }), " となります！"]
    }), "\n", _jsx(_components.h3, {
      id: "キャッシュオブジェクト",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#キャッシュオブジェクト",
        children: "キャッシュオブジェクト"
      })
    }), "\n", _jsx(_components.p, {
      children: "キャッシュのオブジェクトは、ハッシュ値名で、アウトプット(file やログ)のバイナリになります。\nDocker コンテナ内で見ると、次のようなファイルが置かれています。"
    }), "\n", _jsx(_components.figure, {
      "data-rehype-pretty-code-figure": "",
      children: _jsx(_components.pre, {
        tabIndex: "0",
        "data-language": "bash",
        "data-theme": "github-dark github-light",
        children: _jsxs(_components.code, {
          "data-language": "bash",
          "data-theme": "github-dark github-light",
          style: {
            display: "grid"
          },
          children: [_jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "ls"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " -hl"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " storage/team_myteam/"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "total"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " 5392"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "-rw-r--r--"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: "  1"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " silverbirder"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "  staff"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "   1.3M"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Sep"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " 11"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 16:20"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 082bae5de9b1745f"
            })]
          }), "\n", _jsxs(_components.span, {
            "data-line": "",
            children: [_jsx(_components.span, {
              style: {
                "--shiki-dark": "#B392F0",
                "--shiki-light": "#6F42C1"
              },
              children: "-rw-r--r--"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: "  1"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " silverbirder"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "  staff"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: "   1.3M"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " Sep"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#79B8FF",
                "--shiki-light": "#005CC5"
              },
              children: " 11"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 16:20"
            }), _jsx(_components.span, {
              style: {
                "--shiki-dark": "#9ECBFF",
                "--shiki-light": "#032F62"
              },
              children: " 5a55c6367c8caf01"
            })]
          })]
        })
      })
    }), "\n", _jsx(_components.p, {
      children: "--team オプションで指定した名前で、フォルダが作成されています。\nそのため、team 毎にキャッシュが作成されます。"
    }), "\n", _jsx(_components.h3, {
      id: "キャッシュとは",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#キャッシュとは",
        children: "キャッシュとは"
      })
    }), "\n", _jsxs(_components.p, {
      children: ["turborepo のキャッシュについては、", _jsx(_components.a, {
        href: "https://turborepo.org/docs/core-concepts/caching",
        children: "公式"
      }), " を読むと良いでしょう。"]
    }), "\n", _jsx(_components.p, {
      children: "ざっくりいうと、次の流れで cache miss,cache hit になります。"
    }), "\n", _jsxs(_components.ol, {
      children: ["\n", _jsx(_components.li, {
        children: "turbo build を実行"
      }), "\n", _jsxs(_components.li, {
        children: ["turbo.json の", _jsx(_components.code, {
          children: "build"
        }), "タスクの inputs(ソースコードなど)や環境変数をハッシュ化"]
      }), "\n", _jsx(_components.li, {
        children: "キャッシュが既にローカルまたはリモートに存在していなければ、cache miss"
      }), "\n", _jsxs(_components.li, {
        children: ["turbo.json の", _jsx(_components.code, {
          children: "build"
        }), "タスクの outputs(dist フォルダ、標準出力など)をバイナリ化し、ハッシュ名で保存"]
      }), "\n"]
    }), "\n", _jsxs(_components.p, {
      children: ["3 の手順で、キャッシュが存在していれば、", _jsx(_components.code, {
        children: "cache hit"
      }), " となり、outputs が復元します。"]
    }), "\n", _jsx(_components.h2, {
      id: "クラウドでやってみた",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#クラウドでやってみた",
        children: "クラウドで、やってみた"
      })
    }), "\n", _jsx(_components.p, {
      children: "キャッシュサーバは、AWS や GCP などのクラウドベンダーにあるコンピューティングリソースへデプロイしましょう。\nDocker イメージがあるので、AppRunner や CloudRun が楽にできそうです。"
    }), "\n", _jsxs(_components.p, {
      children: ["キャッシュストレージは、いまのところ AWS S3 のみ対応とのことです。\nAWS S3 のクライアントは、", _jsx(_components.a, {
        href: "https://zenn.dev/mizchi/articles/s3-compatible-client",
        children: "S3Client を使っているため、GCS にも対応可能"
      }), "です。まあ README に従うなら、S3 に配置するのがベターでしょう。コンピューティングリソースを動かす IAM は、ストレージリソースへの READ/WRITE 権限を足しましょう。"]
    }), "\n", _jsx(_components.h2, {
      id: "おわりに",
      children: _jsx(_components.a, {
        className: "mdx-heading-anchor",
        href: "#おわりに",
        children: "おわりに"
      })
    }), "\n", _jsx(_components.p, {
      children: "セルフホストして、リモートキャッシュが使えるようになりました。\nまだ運用したことがないので、課題を実感していません。引き続き、利用してみようと思います。"
    })]
  });
}
function MDXContent(props = {}) {
  const {wrapper: MDXLayout} = {
    ..._provideComponents(),
    ...props.components
  };
  return MDXLayout ? _jsx(MDXLayout, {
    ...props,
    children: _jsx(_createMdxContent, {
      ...props
    })
  }) : _createMdxContent(props);
}
return {
  default: MDXContent
};
0:{"buildId":"FFhISK9OdISz_FCZdFfxR","rsc":["$","$1","c",{"children":[["$","$L2",null,{"compiledSource":"$3","followLinks":{"bluesky":"https://bsky.app/profile/silverbirder.bsky.social","github":"https://github.com/silverbirder","rss":"https://silverbirder.github.io/rss.xml","threads":"https://www.threads.com/@silverbirder","x":"https://x.com/silverbirder"},"meta":{"index":false,"postNumber":92,"publishedAt":"2022-09-11","tags":["開発ツール"],"title":"turborepo-remote-cache でキャッシュサーバをセルフホストした"},"navigation":{"next":{"href":"/blog/contents/crawlee-was-useful-for-crawling","publishedAt":"2022-09-14","title":"クローリングをシュッとやるのに、Crawleeが便利だった"},"prev":{"href":"/blog/contents/ernie_vilg_demo","publishedAt":"2022-09-03","title":"ERNIE-ViLG を Google Colaboratory で動かしてみた"}},"relatedPosts":[{"posts":[{"publishedAt":"2026-02-06","slug":"20260206","summary":"ブログ記事のページ下部に、Disqusを設置しています。 急遽、Disqusの上下に良くわからない広告が大量に表示されるようになりました。 Disqusのメール メールボックスを漁ってみると、以下のメールがありました。 Disqusからのメ","tags":["開発ツール"],"title":"Disqusに広告が表示されるようになった"},{"publishedAt":"2025-09-17","slug":"google-my-activity-visualization","summary":"DuckDB WASMとOrigin Private File System (OPFS) を組み合わせ、Google マイアクティビティの履歴をブラウザ内に閉じたまま扱えるようにしたときの設計と学びを整理しました。","tags":["開発ツール","ブラウザ"],"title":"DuckDB WASMとOPFSでGoogleマイアクティビティをブラウザ完結で可視化してみた"},{"publishedAt":"2024-03-21","slug":"try-million-lint","summary":"Million.devを知り、少し試してみました。Million.jsについて このライブラリは、React DevToolsのProfilerより簡単にプロファイリングできるみたいです。 パフォーマンスのプロファイリングは通常、面倒で時間のかかる作業です。もしもこれを簡単に実行できるのであれば、めちゃくちゃ捗るなとわくわくしました。","tags":["テスト","開発ツール"],"title":"Million Lintを試してみた"}],"tag":"開発ツール"}],"shareUrl":"https://silverbirder.github.io/blog/contents/self-hosted_cache_server_with_turborepo-remote-cache/","slug":"self-hosted_cache_server_with_turborepo-remote-cache"}],["$L4"],"$L5"]}],"loading":null,"isPartial":false}
4:["$","script","script-0",{"src":"/_next/static/chunks/f06f97cc5d67ef22.js","async":true}]
5:["$","$L6",null,{"children":["$","$7",null,{"name":"Next.MetadataOutlet","children":"$@8"}]}]
8:null
